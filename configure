#!/bin/bash

pre()
{
	command return 0
}

post()
{
	command return 0
}

configure()
{
	command declare base
	command declare module
	command declare -a modules

	base="$(command dirname ${BASH_SOURCE[0]})"
	modules=("${@}")

	if command test -z "${modules}"
	then
		for module in "${base}/modules"/*/
		do
			module="$(basename ${module})"
			modules+=(${module})
		done
	fi

	for module in "${modules[@]}"
	do
		if command test ! -d "${base}/modules/${module}"
		then
			command continue
		fi

		command echo "Module: ${module}"

		module="${base}/modules/${module}"

		if command test -r "${module}/configure.sh"
		then
			command echo "	Sourcing module configuration script"
			command source "${module}/configure.sh"
		fi

		command echo "	Running pre-configuration hooks"
		pre >> "${module}/configure.log"

		if command test -d "${module}/home"
		then
			command echo "	Copying user files"
			command cp -R "${module}/home/" "${HOME}" >> "${module}/configure.log"
		fi

		if command test -d "${module}/root"
		then
			command echo "	Copying system files"
			command sudo cp -R "${module}/root/" "/" >> "${module}/configure.log"
		fi

		command echo "	Running post-configuration hooks"
		post >> "${module}/configure.log"
	done

	command unset -v base
	command unset -v module
	command unset -v modules
	command return 0
}

(configure "${@}")

command unset -f pre
command unset -f post
command unset -f configure
